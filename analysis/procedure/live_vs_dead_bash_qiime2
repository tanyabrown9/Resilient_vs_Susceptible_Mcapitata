#Antacoma soil microbiome and the moving pictures tutorials were good examples to follow for the sequence data generated by Mr.DNA
#import files after downloadint them from basespace and running through fastq processor from Mr.DNA
qiime tools import --type EMPPairedEndSequences --input-path ../input/time_series_1/emp-paired-end-sequences/ --output-path ../output/emp-paired-end-sequences_time_series_1.qza

#demux must have the no golay error or it freeks out about the primer length. Also barcodes and reverse primers are removed from the fastq processor so the "no rev comp mapping barcodes needs to be there. 
qiime demux emp-paired --m-barcodes-file ../input/time_series_1/sample-metadata.tsv --m-barcodes-column BarcodeSequence --p-no-rev-comp-mapping-barcodes --p-no-golay-error-correction --i-seqs ../output/emp-paired-end-sequences_time_series_1.qza --o-per-sample-sequences ../output/demux-full_time_series_1.qza --o-error-correction-details ../output/demux-details_time_series_1.qza

#visualize the demultiplexed file for sanity
qiime demux summarize --i-data ../output/demux-full_time_series_1.qza --o-visualization ../output/demux_time_series_1.qzv

#trim and denoise sequences using dada2
#no need to trim on left side or right but forward read lengths are a little shorter than reverse reads
qiime dada2 denoise-paired --i-demultiplexed-seqs ../output/demux-full_time_series_1.qza --p-trim-left-f 0 --p-trim-left-r 0 --p-trunc-len-f 273 --p-trunc-len-r 300 --o-table ../output/table_time_series_1.qza --o-representative-sequences ../output/rep-seqs_time_series_1.qza --o-denoising-stats ../output/denoising-stats_time_series_1.qza

#generate visualizations of the table, feature sequences and DADA2 denoising stats
qiime feature-table summarize --i-table ../output/table_time_series_1.qza --o-visualization ../output/table_time_series_1.qzv --m-sample-metadata-file ../input/time_series_1/sample-metadata.tsv 

qiime feature-table tabulate-seqs --i-data ../output/rep-seqs_time_series_1.qza --o-visualization ../output/rep-seqs_time_series_1.qzv

qiime metadata tabulate --m-input-file ../output/denoising-stats_time_series_1.qza --o-visualization ../output/denoising-stats_time_series_1.qzv


#Some of the samples are duplicates so need to merge using the sum function
#merged feature-table
qiime feature-table merge --i-tables ../output/table_time_series_1.qza --i-tables ../output/table_time_series_2.qza --i-tables ../output/table_nutrient_2.qza --i-tables ../output/try_2/table_11_04_20_part2.qza --p-overlap-method 'sum' --o-merged-table ../output/merged_table.qza


#merged feature-table merged-seqs
qiime feature-table merge-seqs --i-data ../output/rep-seqs_time_series_1.qza --i-data ../output/rep-seqs_time_series_2.qza --i-data ../output/rep-seqs_nutrient_2.qza --i-data ../output/try_2/rep-sequences_11_04_20_part_2.qza --o-merged-data ../output/rep-seqs_merged.qza


#manualy combined my metadata files as I can't find a way to do it in qiime
#Filter feature table to only contain the live vs dead samples
qiime feature-table filter-samples --i-table ../output/merged_table.qza --m-metadata-file ../input/sample-metadata_live_vs_dead_combo.tsv --p-where "[Study]='Live_vs_Dead'" --o-filtered-table table_filtered_live_vs_dead.qza

#remove mitochondria and chloroplasts
qiime taxa filter-table --i-table ../output/merged_table.qza --i-taxonomy ../output/silva_metaxa2_reference_taxonomy_live_vs_dead.qza --p-exclude mitochondria,chloroplast --o-filtered-table ../output/feature_table_live_vs_dead.qza

#core metrics
qiime diversity core-metrics --i-table ../output/feature_table_live_vs_dead.qza --p-sampling-depth 1 --m-metadata-file ../input/sample-metadata_live_vs_dead_combo.tsv --output-dir ../output/core_metrics_3_10_21

#core metrics phylogenetic
qiime diversity core-metrics-phylogenetic --i-table ../output/feature_table_live_vs_dead.qza --i-phylogeny ../input/insertion-tree_silva_live_vs_dead_march.qza --p-sampling-depth 1 --m-metadata-file ../input/sample-metadata_live_vs_dead_combo.tsv --output-dir ../output/core_metrics_phylo_6.5.21/


#taxa barplot
qiime taxa barplot --i-table ../output/feature_table_live_vs_dead.qza --i-taxonomy ../output/silva_metaxa2_reference_taxonomy_live_vs_dead.qza --m-metadata-file ../input/sample-metadata_live_vs_dead_combo.tsv --o-visualization ../output/taxa_barplot_live_vs_dead.qzv



#Next will create a SEPP tree using the SILVA-128 reference
#download the reference
wget \
-o "../input/sepp-refs-silva-128.qza \
"http://data.qiime2.org/2019.10/common/sepp-refs-silva-128.qza"

qiime fragment-insertion sepp \
--i-representative-sequences ../output/rep-seqs_merged.qza
--i-reference-database ../input/sepp-refs-silva-128.qza 
--o-tree ../output/silva_live_vs_dead_tree 
--o-placements ../output/silva_live_vs_dead_placements

#taxonomic annotation with the SILVA 136 database. This is found on the Qiime2 website
(qiime2-2020.11) qiime2@qiime2core2020-11:~/Montipora_live_vs_dead/procedure$ qiime feature-classifier classify-consensus-vsearch --i-query ../output/rep-seqs_merged.qza --i-reference-reads ../../Downloads/silva-138-99-seqs.qza --i-reference-taxonomy ../../Downloads/silva-138-99-tax.qza --o-classification ../output/classification_taxonomy_silva

#had problems with ids not matching from my merged and filtered feature table and taxonomy references so I needed to filter those out
(qiime2-2020.11) qiime2@qiime2core2020-11:~/Montipora_live_vs_dead/procedure$ qiime feature-table filter-features --i-table ../input/table_filtered_live_vs_dead.qza --m-metadata-file ../input/silva_metaxa2_reference_taxonomy.qza --o-filtered-table ../output/id-filtered_table_live_vs_dead.qza





